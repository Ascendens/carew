#!/usr/bin/env php
<?php

use dflydev\markdown\MarkdownParser;
use Symfony\Component\Console\Application;
use Symfony\Component\Console\Input\InputInterface;
use Symfony\Component\Console\Output\OutputInterface;
use Symfony\Component\Filesystem\Filesystem;
use Symfony\Component\Finder\Finder;
use Symfony\Component\Yaml\Yaml;

if ((!@include __DIR__.'/../../../autoload.php') && (!@include __DIR__.'/../vendor/autoload.php')) {
    die('You must set up the project dependencies, run the following commands:'.PHP_EOL.
        'curl -s http://getcomposer.org/installer | php'.PHP_EOL.
        'php composer.phar install'.PHP_EOL);
}

function parseMetadata($contents)
{
    preg_match('#---\n(.+)---\n(.+)#s', $contents, $matches);
    if (!$matches) {
        throw new \RuntimeException(sprintf('Could not parse front matter in blog post %s', basename($filename)));
    }

    list(, $rawInfo, $rawBody) = $matches;

    $info = Yaml::parse($rawInfo);

    $markdownParser = new MarkdownParser();
    $body = $markdownParser->transformMarkdown($rawBody);

    return array($info, $body);
}

function parsePost(SplFileInfo $filename, $contents)
{
    list($info, $body) = parseMetadata($contents);

    list($year, $month, $day, $slug) = explode('-', $filename->getBasename('.md'), 4);

    $date = "$year-$month-$day";
    $path = "$year/$month/$day/$slug.html";

    $post = array_replace(array(
        'path'          => $path,
        'date_string'   => $date,
        'date'          => new DateTime($date),
        'body'          => $body,
        'layout'        => 'default',
    ), $info);

    return $post;
}

function parsePage(SplFileInfo $filename, $contents)
{
    list($info, $body) = parseMetadata($contents);

    $slug = $filename->getBasename('.md');
    $path = $filename->getRelativePath() ?: '.';

    $page = array_replace(array(
        'path'          => "$path/$slug.html",
        'body'          => $body,
        'layout'        => 'default',
    ), $info);

    return $page;
}

$console = new Application();
$console
    ->register('build')
    ->setDescription('Builds static html files from markdown source')
    ->setCode(function (InputInterface $input, OutputInterface $output) {
        $baseDir = getcwd();

        $fs = new Filesystem();
        $fs->remove($baseDir.'/web');

        $loader = new Twig_Loader_Filesystem($baseDir.'/layouts');
        $twig = new Twig_Environment($loader, array('strict_variables' => true));

        $getEngine = function ($name) use ($twig) {
            $engines = array(
                'twig'  => function ($filename, $vars) use ($twig) {
                    return $twig->render($filename, $vars);
                },
                'php'   => function ($filename, $vars) {
                    extract($vars);
                    ob_start();
                    require $baseDir.'/layouts'.$filename;

                    return ob_get_clean();
                },
            );

            return $engines[$name];
        };

        $renderLayout = function ($filename, $vars) use ($getEngine) {
            list($layout, $format, $engineName) = explode('.', $filename);

            $engine = $getEngine($engineName);

            return $engine($filename, $vars);
        };

        $posts = array();
        if (is_dir($baseDir.'/posts')) {
            $finder = new Finder();
            foreach ($finder->in($baseDir.'/posts')->files()->name('*-*-*-*.md') as $file) {
                if ($input->getOption('verbose')) {
                    $output->writeln(sprintf('Processing <info>%s</info>', $file->getBasename()));
                }

                $contents = file_get_contents($file);

                $posts[] = $post = parsePost($file, $contents);

                $vars = array('post' => $post, 'relativeRoot' => '../../..');
                $rendered = $renderLayout($post['layout'].'.html.twig', $vars);

                $target = $baseDir.'/web/'.$post['path'];
                $fs->mkdir(dirname($target));
                file_put_contents($target, $rendered);
            }
        }

        $pages = array();
        if (is_dir($baseDir.'/pages')) {
            $finder = new Finder();
            foreach ($finder->in($baseDir.'/pages')->files()->name('*.md') as $file) {
                if ($input->getOption('verbose')) {
                    $output->writeln(sprintf('Processing <info>%s</info>', $file->getBasename()));
                }

                $contents = file_get_contents($file);

                $page = parsePage($file, $contents);
                $pages[$page['path']] = $page;

                $relativeRoot = rtrim(str_repeat('../', substr_count($file->getRelativePath(), DIRECTORY_SEPARATOR) + 1), '/');
                $vars = array('page' => $page, 'relativeRoot' => $relativeRoot);
                $rendered = $renderLayout($page['layout'].'.html.twig', $vars);

                $target = $baseDir.'/web/'.$page['path'];
                $fs->mkdir(dirname($target));
                file_put_contents($target, $rendered);
            }
        }

        if ($input->getOption('verbose')) {
            $output->writeln('Building <info>index</info>');
        }

        usort($posts, function ($a, $b) {
            return strcmp($a['date_string'], $b['date_string']);
        });
        $posts = array_reverse($posts);

        $latest = reset($posts);

        $finder = new Finder();
        foreach ($finder->in($baseDir.'/layouts/')->files()->name('index.*.twig') as $file) {
            $file = $file->getBasename();

            preg_match('#index\.(.+?)\.twig$#', $file, $match);
            $format = $match[1];

            $vars = array(
                'posts'        => $posts,
                'latest'       => $latest,
                'pages'        => $pages,
                'relativeRoot' => '.',
            );
            $rendered = $renderLayout($file, $vars);

            $target = $baseDir.'/web/index.'.$format;
            file_put_contents($target, $rendered);
        }

        if (is_dir($baseDir.'/assets')) {
            $fs->mirror($baseDir.'/assets/', $baseDir.'/web/');
        }
    })
;
$console->run();
